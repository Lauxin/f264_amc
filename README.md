# f264_amc
introduce amc in H264

## H264 MC general
对于有参考帧的P帧的压缩，不做运动估计ME直接做差是一种最简单最直观减少码流的思路，但是做差后的数据中仍然包括很多的冗余信息。ME可以很好的找出当前帧P帧和前一帧中的"像素块"的运动，从而起到减少码流的作用。

H264中的整个INTER部分包括IME、FME和MC。通过整精度和分精度的ME获取当前宏块的较精确的运动向量（指向参考帧中的搜索窗），再在MC这一步分别对得到的MV和当前宏块的pixel进行处理，这两者彼此没有数据依赖。

### MVP
虽然MV本身不大，但是根据相邻位置MV相似这个思路仍然可以进一步压缩MV的数据量。通过相邻块的MV生成当前块的MVP（Motion Vector Prediction），再和IME->FME得到的MV作差得到MVD（Motion Vector Difference）。这样传输就只要传输IDX和MVD就可以了。JPEG中对DCT之后DC系数的编码方式——差分脉冲调制编码（DPCM）利用的是同样的原理。

MVP的生成策略如下：通常情况下，当前块共有三个已编码的相邻块的MV可供选择作为MVP，笼统地讲为左、上、右上四个相邻块，分别称之为A、B、C块，如上图a所示。如果C块不可得的话，可以用D块来替代（左上），如上图b所示。关于具体选择哪一块的MV作为MVP，以及是否需要通过求平均来获取MVP，是根据当前块的参考索引和块划分方式决定的，具体细节要查阅H264标准。

### pixel process
在获得了MV之后，编码器需要根据此运动向量和参考图像（搜索窗）计算出当前块的预测值，具体来说就是通过当前块的位置和前面传过来的MV，在搜索窗中将经过分像素插值（在FME中完成）的参考像素拷贝并覆盖。

## AMC
自然界中的运动物体不只有平动，还有转动，缩放等运动形式，而H265以及之前的编码标准中均只针对平动形式进行运动估计，主要的限制因素有两点：算力不支持复杂的仿射变换预测，使得增加复杂度带来的码率压缩并不具有吸引力；无法得到通用高效的，并且基于块划分的仿射变换算法。

JEM中AME通过两个CP（Control Points）点处的运动向量计算得到宏块中各点的仿射变换运动向量。

在JEM的实际操作中，为了简化运算量，常常不用获取所有像素的MV，而是以4x4块为基本单位进行仿射变换。但是在F264中，帧间预测最小单位就是4x4，我们怀疑若是采用JEM中的4x4子块方案，那么它在像素层面的性能上一定比不过块划分为4x4的宏块，所以在F264的AME中我们采用的是对每一点计算MV的方案。因为H264的宏块本身就不算大，所以实际的运算量并不夸张。

为了简化模型，我们定义AME只在划分为16x16的块中可能采用，这很大程度上限制了AME+AMC的发挥。

采用AME宏块的AMC过程为：①根据AME得到的两个CPs处的AMV得到当前16x16块内所有像素点的MV，再在参考帧搜索窗中找出对应的预测像素放到对应位置；②沿用H265的逻辑，根据相邻块MV/AMV获得CPs处的AMV进而获得AME中的MVP和MVD。后者因为需要根据临近块是否采用AME而需要增加新的更为复杂的MVP生成策略，这在本次报告中并没有对此进行实现。

### AME在H264的妥协
- AME在迭代前的MV candidate获取，由于H264里没有左下角块，在获取候选列表时将其跳过；
- 精度上，JEM中的AME是1/16，而移植到H264的AME设定为1/2；
- 搜索窗大小，实际运行中发现AME经常超出搜索窗，而F264中设定搜索窗尺寸48*48，这就限制了MV必须在12之内（搜索窗中最外层的4个像素用于插值，不是搜索范围）。

### 改进方向和后续应进行的工作
- 增加AME的MVP和MVD
- 增加对8x8/16x8/8x16/4x8/8x4宏块（PU）的AME支持
- Cmodel中加入熵编码（CAVLC）模块以观察实际码流情况，同时需要加上AMV的二值化部分
- 增大搜索窗
